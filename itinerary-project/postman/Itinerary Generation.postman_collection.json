{
	"info": {
		"_postman_id": "c737d4ae-2c95-4ca8-a953-126024636936",
		"name": "Itinerary Generation",
		"schema": "https://schema.getpostman.com/json/collection/v2.0.0/collection.json",
		"_exporter_id": "36471677"
	},
	"item": [
		{
			"name": "HTTP Status, Required Fields and Errors",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const body = pm.iterationData.get(\"body\");\r",
							"if (body) {\r",
							"    pm.request.body.raw = JSON.stringify(body);\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// Check that the correct HTTP status has been sent\r",
							"const expected = pm.iterationData.get(\"expected\")\r",
							"const expectedStatus = pm.iterationData.get(\"expectedStatus\")\r",
							"pm.test(`HTTP ${expectedStatus}`, () => pm.response.to.have.status(expectedStatus));\r",
							"\r",
							"const res = pm.response.json();\r",
							"\r",
							"if (expectedStatus === 200) {\r",
							"    pm.test(\"Response has required fields\", () => {\r",
							"        // check that the errors array isn't present\r",
							"        pm.expect(res).to.not.have.property(\"errors\");\r",
							"\r",
							"        // check that the top-level fields are present\r",
							"        pm.expect(res).to.have.property(\"id\").that.is.a(\"string\");\r",
							"        pm.expect(res).to.have.property(\"name\").that.is.a(\"string\");\r",
							"        pm.expect(res).to.have.property(\"timezone\").that.is.a(\"string\");\r",
							"    \r",
							"        // check the dates object\r",
							"        pm.expect(res).to.have.property(\"dates\").that.is.a(\"object\").that.has.all.keys(\"start\", \"end\");\r",
							"        pm.expect(res.dates.start).to.match(/^\\d{4}-\\d{2}-\\d{2}$/);\r",
							"        pm.expect(res.dates.end).to.match(/^\\d{4}-\\d{2}-\\d{2}$/);\r",
							"\r",
							"        // check the arrays\r",
							"        pm.expect(res).to.have.property(\"unscheduled\").that.is.an(\"array\");\r",
							"        pm.expect(res).to.have.property(\"days\").that.is.an(\"array\");\r",
							"\r",
							"        // check the meta object\r",
							"        pm.expect(res).to.have.property(\"meta\").that.is.a(\"object\").that.has.all.keys(\"generatedBy\", \"version\", \"createdAt\");\r",
							"\r",
							"    });\r",
							"\r",
							"    pm.test(\"Response has expected values for required fields\", () => {\r",
							"        pm.expect(res).to.deep.include({\r",
							"            name: expected.name,\r",
							"            dates: expected.dates\r",
							"        });\r",
							"    });\r",
							"\r",
							"} else {\r",
							"    // check that the error array exists\r",
							"    pm.test(\"Response contains the error array\", () => {\r",
							"        pm.expect(res.errors).to.be.an(\"array\").that.is.not.empty;\r",
							"    });\r",
							"\r",
							"    // check that the correct errors are present\r",
							"    pm.test(\"Contains expected errors\", () => {\r",
							"        const expectedErrors = (expected.errors || []).map(({ field, code }) => ({ field, code }));\r",
							"        const actualErrors = (res.errors || []).map(({ field, code }) => ({ field, code }));\r",
							"\r",
							"        pm.expect(actualErrors).to.have.length(expectedErrors.length)\r",
							"        pm.expect(actualErrors).to.have.deep.members(expectedErrors);\r",
							"    });\r",
							"\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": "{{baseUrl}}/generate"
			},
			"response": []
		},
		{
			"name": "Day Scaffold",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const body = pm.iterationData.get(\"body\");\r",
							"if (body) {\r",
							"    pm.request.body.raw = JSON.stringify(body);\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// run checks if the status is 200 and there is an expected days\r",
							"const expected = pm.iterationData.get(\"expected\")\r",
							"const expectedStatus = pm.iterationData.get(\"expectedStatus\")\r",
							"\r",
							"const res = pm.response.json();\r",
							"\r",
							"if (expected.days && expectedStatus === 200) {\r",
							"    pm.test(\"Contains expected day scaffold\", () => {\r",
							"        const expectedDays = (expected.days || []).map(({ date, destinationId }) => ({ date, destinationId }));\r",
							"        const actualDays = (res.days || []).map(({ date, destinationId }) => ({ date, destinationId }));\r",
							"\r",
							"        pm.expect(actualDays).to.have.length(expectedDays.length)\r",
							"        pm.expect(actualDays).to.deep.have.members(expectedDays);\r",
							"    });\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": "{{baseUrl}}/generate"
			},
			"response": []
		},
		{
			"name": "Anchors",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const body = pm.iterationData.get(\"body\");\r",
							"if (body) {\r",
							"    pm.request.body.raw = JSON.stringify(body);\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// run checks if the status is 200 and there is an expected anchors\r",
							"const expected = pm.iterationData.get(\"expected\")\r",
							"const expectedStatus = pm.iterationData.get(\"expectedStatus\")\r",
							"\r",
							"const res = pm.response.json();\r",
							"\r",
							"if (expected.days && expectedStatus === 200) {\r",
							"    expected.days.forEach(expectedDay => {\r",
							"        pm.test(`Contains expected anchors for ${expectedDay.date}`, () => {\r",
							"            const resDay = res.days.find(day => day.date === expectedDay.date);\r",
							"            pm.expect(resDay).to.exist;\r",
							"            // omit the id out of the res blocks\r",
							"            const resBlocksNormalised = resDay.blocks.map(b => ({\r",
							"                type: b.type,\r",
							"                start: b.start,\r",
							"                end: b.end,\r",
							"                locked: b.locked,\r",
							"                placeRef: b.placeRef,\r",
							"                ...(b.source ? { source: b.source } : {})\r",
							"            }));\r",
							"\r",
							"            pm.expect(resBlocksNormalised).to.have.length(expectedDay.blocks.length)\r",
							"            pm.expect(resBlocksNormalised).have.deep.members(expectedDay.blocks);\r",
							"        });\r",
							"    })\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": "{{baseUrl}}/generate"
			},
			"response": []
		}
	],
	"auth": {
		"type": "bearer",
		"bearer": {
			"token": "{{anonKey}}"
		}
	},
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"packages": {},
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"packages": {},
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "itinerarySchema",
			"value": ""
		}
	]
}